import unittest
from outpost24hiabclient.entities.user import User
from outpost24hiabclient.entities.usergroup import UserGroup
from outpost24hiabclient import Users
from outpost24hiabclient.clients.hiabclient import HiabClient
from unittest.mock import patch

import xml.etree.ElementTree as ET

class HiabClientTest:

    def get_users(self):
        data="<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<RESPONSE ACTION=\"SUBACCOUNTDATA\" TIMESTAMP=\"2021-01-05 17:05\" USERNAME=\"USERNAME10\" VERSION=\"4.22.12.0\">\n<USERLIST>\n<TOTALCOUNT>5</TOTALCOUNT><COLLAPSEDTOTAL>5</COLLAPSEDTOTAL><USER rowid=\"1\"><PARENT>Top Level</PARENT><ILOGON>121</ILOGON><DLASTLOGON>2021-01-05 15:58</DLASTLOGON><SCANNERLIST></SCANNERLIST><AWSARNLIST></AWSARNLIST><ALLSWAT>true</ALLSWAT><IEMAILTYPE>1</IEMAILTYPE><XISUBPARENTID>-1</XISUBPARENTID><TWOFACTORAUTHENTICATION>0</TWOFACTORAUTHENTICATION><GROUPLIST></GROUPLIST><AUTHENTICATIONMETHOD>0</AUTHENTICATIONMETHOD><DCREATED>2019-08-06 13:54</DCREATED><STARTDAYOFWEEK>1</STARTDAYOFWEEK><VCPHONEMOBILE></VCPHONEMOBILE><BOALLHOSTS>true</BOALLHOSTS><EMAILENCRYPTIONKEY>Unencrypted</EMAILENCRYPTIONKEY><TARGETGROUPS></TARGETGROUPS><XPATHUP>,1000,</XPATHUP><USERGROUPLIST></USERGROUPLIST><ALLAWSARN>true</ALLAWSARN><COUNTRY>Netherlands</COUNTRY><VCLASTNAME>testuser1</VCLASTNAME><XID>1000</XID><TICKETPARENT>0</TICKETPARENT><SYSTEMNOTIFICATIONS>false</SYSTEMNOTIFICATIONS><TARGETLIST></TARGETLIST><ALLSCANNERS>true</ALLSCANNERS><BACTIVE>true</BACTIVE><VCEMAIL>test1@test.test</VCEMAIL><SHOWGUIDE>true</SHOWGUIDE><VCFIRSTNAME>testuser1</VCFIRSTNAME><WASMAXIMUMLINKS>2000</WASMAXIMUMLINKS><SWATAPPLICATIONS></SWATAPPLICATIONS><VCFULLNAME>testuser1 testuser1</VCFULLNAME><VCUSERNAME>TESTUSER1</VCUSERNAME><SWATLIST></SWATLIST><SUPERUSER>true</SUPERUSER></USER>\n<USER rowid=\"2\"><PARENT>Top Level</PARENT><ILOGON>0</ILOGON><SCANNERLIST></SCANNERLIST><AWSARNLIST></AWSARNLIST><ALLSWAT>true</ALLSWAT><IEMAILTYPE>1</IEMAILTYPE><XISUBPARENTID>-1</XISUBPARENTID><TWOFACTORAUTHENTICATION>0</TWOFACTORAUTHENTICATION><GROUPLIST></GROUPLIST><AUTHENTICATIONMETHOD>0</AUTHENTICATIONMETHOD><DCREATED>2019-10-04 14:24</DCREATED><STARTDAYOFWEEK>1</STARTDAYOFWEEK><VCPHONEMOBILE></VCPHONEMOBILE><BOALLHOSTS>true</BOALLHOSTS><EMAILENCRYPTIONKEY>Unencrypted</EMAILENCRYPTIONKEY><TARGETGROUPS></TARGETGROUPS><XPATHUP>,1001,</XPATHUP><USERGROUPLIST></USERGROUPLIST><ALLAWSARN>true</ALLAWSARN><COUNTRY>Netherlands</COUNTRY><VCLASTNAME>test2</VCLASTNAME><XID>1001</XID><TICKETPARENT>1000</TICKETPARENT><SYSTEMNOTIFICATIONS>false</SYSTEMNOTIFICATIONS><TARGETLIST></TARGETLIST><ALLSCANNERS>true</ALLSCANNERS><BACTIVE>true</BACTIVE><VCEMAIL>test2@test.test</VCEMAIL><DEMAIL>2019-10-04 14:24</DEMAIL><SHOWGUIDE>true</SHOWGUIDE><VCFIRSTNAME>TEST2</VCFIRSTNAME><WASMAXIMUMLINKS>2000</WASMAXIMUMLINKS><SWATAPPLICATIONS></SWATAPPLICATIONS><VCFULLNAME>Test2 Test2</VCFULLNAME><VCUSERNAME>TEST2</VCUSERNAME><SWATLIST></SWATLIST><SUPERUSER>true</SUPERUSER></USER>\n<USER rowid=\"3\"><PARENT>Top Level</PARENT><ILOGON>0</ILOGON><SCANNERLIST></SCANNERLIST><AWSARNLIST></AWSARNLIST><ALLSWAT>true</ALLSWAT><IEMAILTYPE>1</IEMAILTYPE><XISUBPARENTID>-1</XISUBPARENTID><TWOFACTORAUTHENTICATION>0</TWOFACTORAUTHENTICATION><GROUPLIST>1035,</GROUPLIST><AUTHENTICATIONMETHOD>0</AUTHENTICATIONMETHOD><DCREATED>2019-11-19 13:59</DCREATED><STARTDAYOFWEEK>1</STARTDAYOFWEEK><VCPHONEMOBILE></VCPHONEMOBILE><USERGROUPNAMES>test3</USERGROUPNAMES><BOALLHOSTS>false</BOALLHOSTS><EMAILENCRYPTIONKEY>Unencrypted</EMAILENCRYPTIONKEY><TARGETGROUPS>group1,</TARGETGROUPS><XPATHUP>,1002,</XPATHUP><USERGROUPLIST>1001,</USERGROUPLIST><ALLAWSARN>true</ALLAWSARN><COUNTRY>Netherlands</COUNTRY><VCLASTNAME>user</VCLASTNAME><XID>1002</XID><TICKETPARENT>0</TICKETPARENT><SYSTEMNOTIFICATIONS>false</SYSTEMNOTIFICATIONS><TARGETLIST>0000:0000:0000:0000:0000:0000:0000:0000-FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF\n0.0.0.0-255.255.255.255\nundefined\n</TARGETLIST><ALLSCANNERS>false</ALLSCANNERS><BACTIVE>true</BACTIVE><VCEMAIL>testuser@whatever.com</VCEMAIL><DEMAIL>2019-11-19 13:59</DEMAIL><SHOWGUIDE>true</SHOWGUIDE><VCFIRSTNAME>test</VCFIRSTNAME><WASMAXIMUMLINKS>2000</WASMAXIMUMLINKS><SWATAPPLICATIONS></SWATAPPLICATIONS><VCFULLNAME>test user</VCFULLNAME><VCUSERNAME>TESTUSER</VCUSERNAME><SWATLIST></SWATLIST><SUPERUSER>false</SUPERUSER></USER>\n<USER rowid=\"4\"><PARENT>Top Level</PARENT><ILOGON>1</ILOGON><DLASTLOGON>2019-12-11 16:39</DLASTLOGON><SCANNERLIST></SCANNERLIST><AWSARNLIST></AWSARNLIST><ALLSWAT>true</ALLSWAT><IEMAILTYPE>1</IEMAILTYPE><XISUBPARENTID>-1</XISUBPARENTID><TWOFACTORAUTHENTICATION>0</TWOFACTORAUTHENTICATION><GROUPLIST></GROUPLIST><AUTHENTICATIONMETHOD>0</AUTHENTICATIONMETHOD><DCREATED>2019-12-11 16:34</DCREATED><STARTDAYOFWEEK>1</STARTDAYOFWEEK><VCPHONEMOBILE></VCPHONEMOBILE><BOALLHOSTS>true</BOALLHOSTS><EMAILENCRYPTIONKEY>Unencrypted</EMAILENCRYPTIONKEY><TARGETGROUPS></TARGETGROUPS><XPATHUP>,1003,</XPATHUP><USERGROUPLIST></USERGROUPLIST><ALLAWSARN>true</ALLAWSARN><COUNTRY>Netherlands</COUNTRY><VCLASTNAME>apiuser</VCLASTNAME><XID>1003</XID><TICKETPARENT>0</TICKETPARENT><SYSTEMNOTIFICATIONS>false</SYSTEMNOTIFICATIONS><TARGETLIST></TARGETLIST><ALLSCANNERS>true</ALLSCANNERS><BACTIVE>true</BACTIVE><VCEMAIL>test3@test.test</VCEMAIL><DEMAIL>2019-12-11 16:34</DEMAIL><SHOWGUIDE>true</SHOWGUIDE><VCFIRSTNAME>apiuser</VCFIRSTNAME><WASMAXIMUMLINKS>2000</WASMAXIMUMLINKS><SWATAPPLICATIONS></SWATAPPLICATIONS><VCFULLNAME>apiuser apiuser</VCFULLNAME><VCUSERNAME>TEST3</VCUSERNAME><SWATLIST></SWATLIST><SUPERUSER>true</SUPERUSER></USER>\n<USER rowid=\"5\"><PARENT>Top Level</PARENT><ILOGON>0</ILOGON><SCANNERLIST></SCANNERLIST><AWSARNLIST></AWSARNLIST><ALLSWAT>true</ALLSWAT><IEMAILTYPE>1</IEMAILTYPE><XISUBPARENTID>-1</XISUBPARENTID><TWOFACTORAUTHENTICATION>2</TWOFACTORAUTHENTICATION><GROUPLIST></GROUPLIST><AUTHENTICATIONMETHOD>1</AUTHENTICATIONMETHOD><DCREATED>2020-05-20 21:02</DCREATED><STARTDAYOFWEEK>1</STARTDAYOFWEEK><VCPHONEMOBILE>61290000</VCPHONEMOBILE><USERGROUPNAMES>test3</USERGROUPNAMES><BOALLHOSTS>true</BOALLHOSTS><EMAILENCRYPTIONKEY>Unencrypted</EMAILENCRYPTIONKEY><TARGETGROUPS></TARGETGROUPS><XPATHUP>,1007,</XPATHUP><USERGROUPLIST>1001,</USERGROUPLIST><ALLAWSARN>true</ALLAWSARN><COUNTRY>Nepal</COUNTRY><VCLASTNAME>test3</VCLASTNAME><XID>1007</XID><TICKETPARENT>0</TICKETPARENT><SYSTEMNOTIFICATIONS>false</SYSTEMNOTIFICATIONS><TARGETLIST></TARGETLIST><ALLSCANNERS>true</ALLSCANNERS><BACTIVE>true</BACTIVE><VCEMAIL>test3@test.test</VCEMAIL><DEMAIL>2020-05-20 21:02</DEMAIL><SHOWGUIDE>true</SHOWGUIDE><VCFIRSTNAME>test2</VCFIRSTNAME><WASMAXIMUMLINKS>2000</WASMAXIMUMLINKS><SWATAPPLICATIONS></SWATAPPLICATIONS><VCFULLNAME>test2 test3</VCFULLNAME><VCUSERNAME>TEST3</VCUSERNAME><SWATLIST></SWATLIST><SUPERUSER>false</SUPERUSER></USER>\n</USERLIST></RESPONSE>"
        xmldata = ET.fromstring(data)
        userlist = xmldata.findall('USERLIST')
        if(len(userlist) >= 1):
            users = userlist[0].findall('USER')
            return [User(self,u) for u in users]
        return []

    def get_usergroups(self):
        data="<?xml version=\"1.0\" encoding=\"UTF-8\"?><RESPONSE ACTION=\"USERGROUPDATA\" TIMESTAMP=\"2021-01-28 10:38\" USERNAME=\"ACCEPTANCE\" VERSION=\"4.22.12.0\"><USERGROUPLIST><TOTALCOUNT>3</TOTALCOUNT><COLLAPSEDTOTAL>3</COLLAPSEDTOTAL><USERGROUP rowid=\"1\"><WEBAPPDELETEREPORT>false</WEBAPPDELETEREPORT><BODISABLE>false</BODISABLE><BHMONITOR>false</BHMONITOR><WEBAPPADMIN>false</WEBAPPADMIN><COMPLIANCE_ENABLED>true</COMPLIANCE_ENABLED><VERIFYSCAN>false</VERIFYSCAN><BOVULTEXT>false</BOVULTEXT><XID>1000</XID><XUPDATOR>-1000</XUPDATOR><SWATCOMMENT>false</SWATCOMMENT><READONLY>false</READONLY><WEBAPPREPORTING>false</WEBAPPREPORTING><BODELETEREPORT>false</BODELETEREPORT><WASX>false</WASX><DASHBOARD>false</DASHBOARD><BOEMAIL>false</BOEMAIL><PCIREPORTING>false</PCIREPORTING><BSUBADMIN>false</BSUBADMIN><BTICKETMANAGEMENT>false</BTICKETMANAGEMENT><RULEADMIN>false</RULEADMIN><PCISCHEDULING>false</PCISCHEDULING><APPROVECOMPLIANCEQUESTIONS>false</APPROVECOMPLIANCEQUESTIONS><RULEMANAGEMENT>false</RULEMANAGEMENT><XUSERXID>11</XUSERXID><AUTORULES>false</AUTORULES><VCNAME>role1</VCNAME><BOSETTINGS>true</BOSETTINGS><STOPSCAN>true</STOPSCAN><FORCEGROUPSCHEDULING>true</FORCEGROUPSCHEDULING><MANAGEDSERVICESCOMMENT>false</MANAGEDSERVICESCOMMENT><GRANTALLTICKETS>false</GRANTALLTICKETS><BOREPORTS>false</BOREPORTS><SWATVERIFICATION>false</SWATVERIFICATION><ANSWERCOMPLIANCEQUESTIONS>false</ANSWERCOMPLIANCEQUESTIONS><READ_AUDITLOGS>false</READ_AUDITLOGS><BOADMINGROUPS>true</BOADMINGROUPS><BACCEPTRISK>false</BACCEPTRISK><READLICENSE>false</READLICENSE><EDITCOMPLIANCEPOLICIES>true</EDITCOMPLIANCEPOLICIES><WEB>false</WEB><PCISCOPING>false</PCISCOPING><SUBMITSCOPING>false</SUBMITSCOPING><SWATRISKS>false</SWATRISKS><BOSCHEDULES>true</BOSCHEDULES><SWATDISCUSSION>false</SWATDISCUSSION><BADMINUSERGROUP>false</BADMINUSERGROUP><MARKCOMPLIANCEEXCEPTIONS>false</MARKCOMPLIANCEEXCEPTIONS><BHADMIN>false</BHADMIN><BOSMS>false</BOSMS><PCIDISPUTING>false</PCIDISPUTING><MANAGEDSERVICES>false</MANAGEDSERVICES><EDITRULES>false</EDITRULES></USERGROUP><USERGROUP rowid=\"2\"><WEBAPPDELETEREPORT>false</WEBAPPDELETEREPORT><BODISABLE>false</BODISABLE><BHMONITOR>false</BHMONITOR><WEBAPPADMIN>false</WEBAPPADMIN><COMPLIANCE_ENABLED>false</COMPLIANCE_ENABLED><VERIFYSCAN>false</VERIFYSCAN><BOVULTEXT>false</BOVULTEXT><XID>1001</XID><XUPDATOR>-1000</XUPDATOR><SWATCOMMENT>false</SWATCOMMENT><READONLY>false</READONLY><WEBAPPREPORTING>false</WEBAPPREPORTING><BODELETEREPORT>false</BODELETEREPORT><WASX>false</WASX><DASHBOARD>false</DASHBOARD><BOEMAIL>false</BOEMAIL><PCIREPORTING>false</PCIREPORTING><BSUBADMIN>false</BSUBADMIN><BTICKETMANAGEMENT>false</BTICKETMANAGEMENT><LDAPGROUP/><RULEADMIN>false</RULEADMIN><PCISCHEDULING>false</PCISCHEDULING><APPROVECOMPLIANCEQUESTIONS>false</APPROVECOMPLIANCEQUESTIONS><RULEMANAGEMENT>false</RULEMANAGEMENT><XUSERXID>11</XUSERXID><AUTORULES>false</AUTORULES><VCNAME>role2</VCNAME><BOSETTINGS>false</BOSETTINGS><STOPSCAN>false</STOPSCAN><FORCEGROUPSCHEDULING>true</FORCEGROUPSCHEDULING><MANAGEDSERVICESCOMMENT>false</MANAGEDSERVICESCOMMENT><GRANTALLTICKETS>false</GRANTALLTICKETS><BOREPORTS>false</BOREPORTS><SWATVERIFICATION>false</SWATVERIFICATION><ANSWERCOMPLIANCEQUESTIONS>false</ANSWERCOMPLIANCEQUESTIONS><READ_AUDITLOGS>false</READ_AUDITLOGS><BOADMINGROUPS>true</BOADMINGROUPS><BACCEPTRISK>false</BACCEPTRISK><READLICENSE>false</READLICENSE><EDITCOMPLIANCEPOLICIES>false</EDITCOMPLIANCEPOLICIES><WEB>false</WEB><PCISCOPING>false</PCISCOPING><SUBMITSCOPING>false</SUBMITSCOPING><SWATRISKS>false</SWATRISKS><BOSCHEDULES>false</BOSCHEDULES><SWATDISCUSSION>false</SWATDISCUSSION><BADMINUSERGROUP>false</BADMINUSERGROUP><MARKCOMPLIANCEEXCEPTIONS>false</MARKCOMPLIANCEEXCEPTIONS><BHADMIN>false</BHADMIN><BOSMS>false</BOSMS><PCIDISPUTING>false</PCIDISPUTING><MANAGEDSERVICES>false</MANAGEDSERVICES><EDITRULES>false</EDITRULES></USERGROUP><USERGROUP rowid=\"3\"><WEBAPPDELETEREPORT>false</WEBAPPDELETEREPORT><BODISABLE>true</BODISABLE><BHMONITOR>false</BHMONITOR><WEBAPPADMIN>false</WEBAPPADMIN><COMPLIANCE_ENABLED>true</COMPLIANCE_ENABLED><VERIFYSCAN>true</VERIFYSCAN><BOVULTEXT>true</BOVULTEXT><XID>1002</XID><XUPDATOR>-1000</XUPDATOR><SWATCOMMENT>false</SWATCOMMENT><READONLY>false</READONLY><WEBAPPREPORTING>false</WEBAPPREPORTING><BODELETEREPORT>false</BODELETEREPORT><WASX>false</WASX><DASHBOARD>true</DASHBOARD><BOEMAIL>true</BOEMAIL><PCIREPORTING>false</PCIREPORTING><BSUBADMIN>false</BSUBADMIN><BTICKETMANAGEMENT>true</BTICKETMANAGEMENT><RULEADMIN>false</RULEADMIN><PCISCHEDULING>false</PCISCHEDULING><APPROVECOMPLIANCEQUESTIONS>false</APPROVECOMPLIANCEQUESTIONS><RULEMANAGEMENT>false</RULEMANAGEMENT><XUSERXID>11</XUSERXID><AUTORULES>false</AUTORULES><VCNAME>role3</VCNAME><BOSETTINGS>false</BOSETTINGS><STOPSCAN>false</STOPSCAN><FORCEGROUPSCHEDULING>true</FORCEGROUPSCHEDULING><MANAGEDSERVICESCOMMENT>false</MANAGEDSERVICESCOMMENT><GRANTALLTICKETS>false</GRANTALLTICKETS><BOREPORTS>true</BOREPORTS><SWATVERIFICATION>false</SWATVERIFICATION><ANSWERCOMPLIANCEQUESTIONS>false</ANSWERCOMPLIANCEQUESTIONS><READ_AUDITLOGS>false</READ_AUDITLOGS><BOADMINGROUPS>true</BOADMINGROUPS><BACCEPTRISK>true</BACCEPTRISK><READLICENSE>false</READLICENSE><EDITCOMPLIANCEPOLICIES>true</EDITCOMPLIANCEPOLICIES><WEB>false</WEB><PCISCOPING>false</PCISCOPING><SUBMITSCOPING>false</SUBMITSCOPING><SWATRISKS>false</SWATRISKS><BOSCHEDULES>false</BOSCHEDULES><SWATDISCUSSION>false</SWATDISCUSSION><BADMINUSERGROUP>false</BADMINUSERGROUP><MARKCOMPLIANCEEXCEPTIONS>false</MARKCOMPLIANCEEXCEPTIONS><BHADMIN>false</BHADMIN><BOSMS>false</BOSMS><PCIDISPUTING>false</PCIDISPUTING><MANAGEDSERVICES>false</MANAGEDSERVICES><EDITRULES>false</EDITRULES></USERGROUP></USERGROUPLIST></RESPONSE>"
        xmldata = ET.fromstring(data)
        usergrouplist = xmldata.findall('USERGROUPLIST')
        if(len(usergrouplist) >= 1):
            usergroups = usergrouplist[0].findall('USERGROUP')
            return [UserGroup(self,g) for g in usergroups]
        return []

class UserServiceTests(unittest.TestCase):

    @patch.object(HiabClient, '__init__', lambda x, y, z: None)
    def setUp(self):
        service = Users("url", "token")
        # now we mock the HiabClient within the service class
        service._hiabclient = HiabClientTest()
        self.user_service = service

    def test_get_users_in_usergroup(self):
        usergroups = self.user_service.get_usergroups()
        usergroup0 = usergroups[0]
        usergroup1 = usergroups[1]
        usergroup2 = usergroups[2]
        users0 = self.user_service.get_users_in_usergroup(usergroup0)
        users1 = self.user_service.get_users_in_usergroup(usergroup1)
        users2 = self.user_service.get_users_in_usergroup(usergroup2)

        self.assertEqual(len(users0),0)
        self.assertEqual(len(users1),2)
        self.assertEqual(len(users2),0)
        self.assertEqual(users1[0].vcusername, "TESTUSER")
        self.assertEqual(users1[1].vcusername, "TEST3")

    def test_get_usergroups_of_user(self):
        user = self.user_service.get_user_by_username("TESTUSER")
        usergroups = self.user_service.get_usergroups_of_user(user)
        self.assertEqual(len(usergroups), 1)
        self.assertEqual(usergroups[0].vcname, "role2")

